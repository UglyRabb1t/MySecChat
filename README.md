# 使用公钥证书和混合加密的模拟聊天程序

*作者：10215101517 唐喆*

实现一个简单的安全聊天场景：

## 使用算法

+ 数字签名 DSA
+ 哈希 MD5
+ 对称 AES
+ 公钥 RSA

密钥长度参数都可以在文件中修改全局变量决定

> 之前的AES用的是C++实现，要转换太麻烦；尝试python调用C++文件（见libaes.so），C++代码的结构也不太对。所以这里偷个懒用了三方库。

## 设计想法

可信机构用`机构私钥`对`用户ID+用户公钥`进行`签名`，作为`证书`。

聊天开始时先互发`证书`。

聊天消息传输时，用`混合加密`：`对称`加密消息，`公钥`加密对称密钥。

DSA参数由OpenSSL生成。现在也支持自己实现的手动生成了，但是方法并不严谨？

消息加密方式：`转化为UTF-8字节 -> 填充 -> AES加密 -> 转化为Base64字节 -> UTF-8解码，用于发送`

密文解密方式：`从Base64转化为生密文 -> AES解密 -> 去填充 -> UTF-8解码为字符串`

> 其中，由于JSON没有字符类型，所以需要将密文转为UTF-8来存放，但由于密文是无规则的，所以要先用Base64编码

### 流程

+ 可信机构作为一个程序，负责生成证书。
+ 发布证书文件。
+ 聊天程序启动
  1. 要求输入对方证书的路径（发送证书）
  2. 验证证书
  3. 验证失败直接退出并告知对方
+ 验证成功后，生成AES密钥
+ 启动两个程序，开启收发线程
  + 发送加密过的消息和密钥，保存到文件中
  + 获取文件中消息，解密并输出到终端

### 消息设计

包含 id

包含 type = {CERT|MSG|END}

+ CERT
  + 包含证书路径，需要校验
+ MSG
  + 包含密文和密钥
+ END
  + 标志终止，包含终止原因（不加密）

### 可分三个文件夹

+ Alice材料：Alice的RSA密钥对；AES密钥
+ Bob材料：Bob的RSA密钥对；AES密钥
+ 公开内容：机构的DSA密钥对（当然，实际中不应该公开私钥）；双方的证书；聊天内容，包含消息ID，加密的AES密钥和消息。

数据均使用`json`文件形式存储，由于json存在数字精度限制，因此存储时应采用字符串形式

如果使用openssl库可以生成`.pem`文件

## 程序使用

1. `DSAKeyGen.py` 生成 CA 的密钥；`RSAKeyGen.py` 生成 Alice 和 Bob 的密钥
2. `CertFGen.py` 生成 Alice 和 Bob 的公钥证书
3. 启动各自的 `main.py` 即可开始聊天。由于设置了启动认证的时限，应该尽快将两个程序都启动。